# 🎁 Логика бесплатных попыток - Правильная реализация

## 📋 Требование

**Бесплатная попытка должна списываться при КАЖДОМ запросе анализа профиля**, независимо от того, берётся ли результат из кэша или выполняется реальный парсинг.

**После использования 1 бесплатной попытки** пользователь может пользоваться сайтом только платно по подписке.

---

## ✅ Правильная логика (ТЕКУЩАЯ реализация)

### Схема работы:

```
┌─────────────────────────────────────────────────────────┐
│ 1. Пользователь отправляет запрос на анализ @username  │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 2. Проверка прав доступа (check_user_can_analyze)      │
│    - Админ? → Пропустить                               │
│    - Подписка? → Пропустить                            │
│    - Бесплатная попытка доступна? → Продолжить         │
│    - Попыток нет? → ОШИБКА 403                         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 3. ⚡ КРИТИЧНО: Списать попытку СРАЗУ                  │
│    await record_free_trial_usage(user_id, username)     │
│    → Попытка потрачена: 1/1                            │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 4. Проверить кэш                                        │
│    cached_result = get_cached_analysis(username)        │
└─────────────────────────────────────────────────────────┘
                        ↓
          ┌─────────────┴─────────────┐
          │                           │
        Есть кэш?                  Нет кэша?
          │                           │
          ↓                           ↓
┌──────────────────────┐    ┌──────────────────────┐
│ 5a. Вернуть кэш      │    │ 5b. Выполнить парсинг│
│     (попытка уже     │    │     profile + posts  │
│     потрачена!)      │    │     + AI analysis    │
└──────────────────────┘    └──────────────────────┘
          │                           │
          └─────────────┬─────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 6. Вернуть результат пользователю                       │
│    Бесплатная попытка: 1/1 использовано                │
│    Следующий запрос → Требуется подписка               │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 Ключевые моменты

### ✅ Правильно:

1. **Попытка списывается НЕМЕДЛЕННО** после проверки прав доступа
2. **Кэшированный результат НЕ экономит попытку** - она уже потрачена
3. **Один запрос = одна попытка**, независимо от источника данных
4. **После использования** → только платная подписка

### 🎁 Преимущества для пользователя:

- **Быстрый ответ из кэша** - если профиль уже анализировался
- **Актуальные данные** - если кэша нет
- **Честная монетизация** - каждый запрос считается

### 💰 Преимущества для бизнеса:

- **Чёткая граница** между free и paid
- **Мотивация подписаться** после первого использования
- **Кэш ускоряет работу** всем пользователям (включая бесплатных)

---

## 📊 Примеры использования

### Пример 1: Первый запрос (без кэша)

```
Пользователь: FREE (0/1 использовано)
Запрос: @charlidamelio

→ Проверка прав: ✅ Можно использовать
→ Списание попытки: ✅ 1/1
→ Проверка кэша: ❌ Не найдено
→ Парсинг: ✅ Полный анализ (60-120 сек)
→ Сохранение в кэш: ✅
→ Результат: ✅ Профиль + тренды

Состояние: FREE (1/1 использовано) → Требуется подписка
```

### Пример 2: Второй запрос того же профиля (из кэша)

```
Пользователь: FREE (1/1 использовано)
Запрос: @charlidamelio (тот же профиль)

→ Проверка прав: ❌ Попытка использована
→ ОШИБКА 403: "You've used your free daily analysis. Subscribe to get unlimited access!"
```

### Пример 3: Следующий день (новая попытка)

```
Пользователь: FREE (0/1 использовано) ← Сброс в 00:00 UTC
Запрос: @zachking

→ Проверка прав: ✅ Новая попытка доступна
→ Списание попытки: ✅ 1/1
→ Проверка кэша: ❌ Новый профиль
→ Парсинг: ✅ Полный анализ
→ Результат: ✅

Состояние: FREE (1/1 использовано) → Требуется подписка
```

### Пример 4: Платный подписчик

```
Пользователь: PAID (активная подписка)
Запрос: @charlidamelio

→ Проверка прав: ✅ Подписка активна
→ Списание попытки: ❌ Не требуется
→ Проверка кэша: ✅ Найдено (мгновенно!)
→ Результат: ✅ Из кэша (< 1 сек)

Состояние: PAID → Неограниченный доступ
```

---

## 🔧 Реализация в коде

### `backend/main.py` (строки 346-372)

```python
# CRITICAL: Record free trial usage IMMEDIATELY for free users
# Free trial is consumed on EVERY request (cached or not)
# Only paid subscribers get benefit of cached results
if is_free_trial_usage:
    try:
        await record_free_trial_usage(current_user.id, username)
        logger.info(
            f"🎁 Free trial used by {current_user.username} for @{username}")
    except Exception as e:
        logger.error(f"❌ Failed to record free trial usage: {e}")
        raise HTTPException(
            status_code=500,
            detail="Failed to record free trial usage"
        )

# Check cache - but free trial users already consumed their attempt
# Paid subscribers benefit from faster cached responses
cached_result = await trend_service.get_cached_analysis(username)

if cached_result:
    print(f"📋 BACKEND: Returning CACHED result for @{username}")
    if is_free_trial_usage:
        logger.info(
            f"📋 Cached result for @{username} (free trial already consumed)")
    else:
        logger.info(f"📋 Cached result for @{username} (subscription)")
    return cached_result
```

---

## 🛡️ Защита от race condition

Блокировка применяется **ПОСЛЕ** списания попытки, чтобы предотвратить дублирование парсинга:

```python
# Acquire lock to prevent duplicate processing
lock_name = f"analysis:{current_user.id}:{username}"
lock_acquired = await cache_service.acquire_lock(lock_name, timeout=60)

if not lock_acquired:
    # Another request is already processing
    # Wait and return cached result when ready
    await asyncio.sleep(2)
    cached_result = await trend_service.get_cached_analysis(username)

    if cached_result:
        return cached_result  # Attempt already consumed, return cache
    else:
        raise HTTPException(409, "Analysis in progress")
```

---

## ✅ Преимущества текущей реализации

### 1. Честная монетизация

- ✅ Каждый запрос считается как попытка
- ✅ Нет способа "обмануть" систему кэшем
- ✅ Чёткая граница: 1 попытка → подписка

### 2. Быстрая работа

- ✅ Кэш ускоряет ответы (даже для free)
- ✅ Меньше нагрузки на API (Ensemble, OpenAI)
- ✅ Экономия токенов

### 3. Защита от злоупотреблений

- ✅ Попытка списывается ДО любых операций
- ✅ Невозможно отправить несколько запросов одновременно
- ✅ Redis блокировка предотвращает дублирование

---

## 📈 Метрики и аналитика

### Отслеживаемые события:

```python
# FREE user - первый запрос
logger.info("🎁 Free trial used by user123 for @charlidamelio")
logger.info("📋 Cached result for @charlidamelio (free trial already consumed)")

# PAID user
logger.info("💳 User user456 using SUBSCRIPTION")
logger.info("📋 Cached result for @zachking (subscription)")
```

### Аналитика:

- **Free trial conversion rate**: Сколько free → paid
- **Cache hit rate (free)**: Процент кэша для бесплатных
- **Cache hit rate (paid)**: Процент кэша для платных
- **Average response time (free)**: Среднее время ответа
- **Average response time (paid)**: Среднее время ответа

---

## 🎓 Сравнение подходов

| Критерий           | ❌ Старый (кэш не списывает) | ✅ Новый (кэш списывает) |
| ------------------ | ---------------------------- | ------------------------ |
| **Справедливость** | Можно получить кэш бесплатно | Каждый запрос считается  |
| **Монетизация**    | Слабая мотивация подписаться | Сильная мотивация        |
| **Кэш для free**   | Не тратит попытку            | Тратит попытку           |
| **Кэш для paid**   | Ускоряет ответ               | Ускоряет ответ           |
| **Бизнес-логика**  | Непонятная                   | Чёткая                   |

---

## 🚀 Итого

**Текущая реализация:**

✅ Попытка списывается при КАЖДОМ запросе  
✅ Кэш не экономит попытку  
✅ После 1 попытки → только подписка  
✅ Защита от race condition  
✅ Быстрая работа через кэш  
✅ Честная монетизация

**Логика:**

```
1 запрос = 1 попытка (независимо от кэша)
1 попытка в день → Подписка для неограниченного доступа
```

---

**Дата:** 2025-10-04  
**Версия:** 2.0  
**Статус:** ✅ Правильная логика реализована

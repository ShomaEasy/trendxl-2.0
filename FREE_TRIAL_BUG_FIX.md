# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–ª–∞—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ–≥–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–∞–ª—Å—è –∏–∑ –∫—ç—à–∞.

### üî¥ –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã

**–§–∞–π–ª:** `backend/main.py` (—Å—Ç—Ä–æ–∫–∏ 346-365, –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

**–ë–∞–≥:** –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å—ã–≤–∞–ª–∞—Å—å **–î–û** –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—ç—à–∞:

```python
# ‚ùå –ü–†–û–ë–õ–ï–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê (–î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø)

# 1. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
if is_free_trial_usage:
    await record_free_trial_usage(current_user.id, username)

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –ü–û–°–õ–ï –∑–∞–ø–∏—Å–∏
cached_result = await trend_service.get_cached_analysis(username)

if cached_result:
    return cached_result  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à, –Ω–æ –ø–æ–ø—ã—Ç–∫–∞ —É–∂–µ —Å–ø–∏—Å–∞–Ω–∞!

# 3. –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä—Å–∏–Ω–≥
result = await trend_service.analyze_profile_trends(...)
```

### üìä –°—Ü–µ–Ω–∞—Ä–∏–π –±–∞–≥–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ó–ê–ü–†–û–° 1: –ü–∞—Ä—Å–∏–Ω–≥ @username (–ü–µ—Ä–≤—ã–π —Ä–∞–∑)                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ can_analyze() ‚Üí OK (0/1 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ)          ‚îÇ
‚îÇ ‚ùå –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫—É ‚Üí 1/1                                 ‚îÇ
‚îÇ ‚ùå –ö—ç—à –Ω–µ –Ω–∞–π–¥–µ–Ω                                            ‚îÇ
‚îÇ ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ–º –†–ï–ê–õ–¨–ù–´–ô –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ—Ñ–∏–ª—è                       ‚îÇ
‚îÇ ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—ç—à                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ó–ê–ü–†–û–° 2: –ü–∞—Ä—Å–∏–Ω–≥ @username (–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å)                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ can_analyze() ‚Üí OK (0/1 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ)          ‚îÇ
‚îÇ ‚ùå –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫—É ‚Üí 1/1  ‚Üê ‚ö†Ô∏è –ü–û–¢–ï–†–Ø –ü–û–ü–´–¢–ö–ò!          ‚îÇ
‚îÇ ‚úÖ –ù–∞–π–¥–µ–Ω –∫—ç—à                                               ‚îÇ
‚îÇ ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à (–ë–ï–ó –ø–∞—Ä—Å–∏–Ω–≥–∞!)  ‚Üê üêõ –ë–ê–ì!              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ü–†–û–ë–õ–ï–ú–ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–ª –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –ø–æ–ø—ã—Ç–∫—É,
          —Ö–æ—Ç—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ –±—ã–ª–æ!
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –î–û –∑–∞–ø–∏—Å–∏ –ø–æ–ø—ã—Ç–∫–∏ ‚≠ê (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

**–õ–æ–≥–∏–∫–∞:**

1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
2. –ï—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ë–ï–ó –∑–∞–ø–∏—Å–∏ –ø–æ–ø—ã—Ç–∫–∏
3. –ï—Å–ª–∏ –Ω–µ—Ç –∫—ç—à–∞ ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫—É –∏ –¥–µ–ª–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥

**–§–∞–π–ª:** `backend/main.py`

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –°–ù–ê–ß–ê–õ–ê
cached_result = await trend_service.get_cached_analysis(username)

if cached_result:
    logger.info(f"üìã Returning cached analysis (NO free trial used)")
    return cached_result  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à –ë–ï–ó —Å–ø–∏—Å–∞–Ω–∏—è –ø–æ–ø—ã—Ç–∫–∏!

# 2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫—É –¢–û–õ–¨–ö–û –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
if is_free_trial_usage:
    await record_free_trial_usage(current_user.id, username)

# 3. –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä—Å–∏–Ω–≥
result = await trend_service.analyze_profile_trends(...)
```

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç Race Condition

### –ü—Ä–æ–±–ª–µ–º–∞ race condition

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:

```
–ó–∞–ø—Ä–æ—Å A                     –ó–∞–ø—Ä–æ—Å B
    ‚îÇ                            ‚îÇ
    ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (–Ω–µ—Ç)      ‚îÇ
    ‚îÇ                            ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (–Ω–µ—Ç)
    ‚îú‚îÄ –ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É (1/1)   ‚îÇ
    ‚îÇ                            ‚îú‚îÄ –ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É (2/1) ‚ùå
    ‚îú‚îÄ –ù–∞—á–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥           ‚îÇ
    ‚îÇ                            ‚îú‚îÄ –ù–∞—á–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ –¥–≤–∞–∂–¥—ã, –æ–±–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

### –†–µ—à–µ–Ω–∏–µ: Redis Lock

**–§–∞–π–ª:** `backend/services/cache_service.py`

```python
async def acquire_lock(self, lock_name: str, timeout: int = 30) -> bool:
    """
    –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —á–µ—Ä–µ–∑ Redis

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Redis SET NX EX (Set if Not Exists with Expiration)
    """
    lock_key = f"trendxl:v2:lock:{lock_name}"
    result = self.redis_client.set(lock_key, "1", nx=True, ex=timeout)
    return bool(result)

async def release_lock(self, lock_name: str) -> bool:
    """–û—Å–≤–æ–±–æ–¥–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É"""
    lock_key = f"trendxl:v2:lock:{lock_name}"
    return bool(self.redis_client.delete(lock_key))
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ `backend/main.py`:**

```python
# –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º
lock_name = f"analysis:{current_user.id}:{username}"
lock_acquired = await cache_service.acquire_lock(lock_name, timeout=60)

if not lock_acquired:
    # –î—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
    await asyncio.sleep(2)  # –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã
    cached_result = await trend_service.get_cached_analysis(username)

    if cached_result:
        return cached_result
    else:
        raise HTTPException(
            status_code=409,
            detail="Analysis already in progress"
        )

try:
    # –ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑
    if is_free_trial_usage:
        await record_free_trial_usage(current_user.id, username)

    result = await trend_service.analyze_profile_trends(...)
finally:
    # –í—Å–µ–≥–¥–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    await cache_service.release_lock(lock_name)
```

---

## üìù –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ edge cases

### 1. –ö—ç—à –∏—Å—Ç–µ–∫–∞–µ—Ç –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π:**

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
- –ö—ç—à –Ω–∞–π–¥–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–µ–Ω –ë–ï–ó —Å–ø–∏—Å–∞–Ω–∏—è –ø–æ–ø—ã—Ç–∫–∏
- –ß–µ—Ä–µ–∑ 1 —á–∞—Å –∫—ç—à –∏—Å—Ç–µ–∫–∞–µ—Ç
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —Å–Ω–æ–≤–∞ –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å
- –ö—ç—à–∞ –Ω–µ—Ç ‚Üí –ø–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ. TTL –∫—ç—à–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–∞–∫, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏.

### 2. Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–°—Ü–µ–Ω–∞—Ä–∏–π:** Redis –≤—ã–∫–ª—é—á–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**

```python
if not self.enabled:
    return True  # –†–∞–∑—Ä–µ—à–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
```

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Redis, –Ω–æ –±–µ–∑ –∑–∞—â–∏—Ç—ã –æ—Ç race condition.

### 3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –∫—Ä–∞—à–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –°–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞

**–†–µ—à–µ–Ω–∏–µ:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–º–µ–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–∞—É—Ç (60 —Å–µ–∫—É–Ω–¥), –ø–æ—Å–ª–µ —á–µ–≥–æ Redis –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—ë —É–¥–∞–ª—è–µ—Ç.

### 4. –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç username:

```python
lock_name = f"analysis:{user_id}:{username}"
```

–†–∞–∑–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Ä–∞–∑–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

---

## üîß –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `backend/main.py`

- ‚úÖ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –î–û –∑–∞–ø–∏—Å–∏ –ø–æ–ø—ã—Ç–∫–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è/–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

### 2. `backend/services/cache_service.py`

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `acquire_lock()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `release_lock()`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —á–µ—Ä–µ–∑ Redis

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

### 1. –ß–µ—Å—Ç–Ω—ã–π —É—á—ë—Ç –ø–æ–ø—ã—Ç–æ–∫

- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç –ø–æ–ø—ã—Ç–∫–∏
- ‚úÖ –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ç–µ—Ä—è–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞–ø—Ä–∞—Å–Ω–æ

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç race condition

- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É –¥–≤–∞–∂–¥—ã
- ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∂–¥—ë—Ç –∫—ç—à–∞ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ

### 3. Graceful degradation

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Redis (fallback)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```bash
# –î–µ–Ω—å 1: –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
POST /api/v1/analyze {"profile_url": "@username"}
‚Üí –ü–æ–ø—ã—Ç–∫–∞: 0/1 ‚Üí 1/1
‚Üí –ö—ç—à: ‚ùå
‚Üí –ü–∞—Ä—Å–∏–Ω–≥: ‚úÖ
‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ

# –î–µ–Ω—å 1: –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (—Ç–æ—Ç –∂–µ –ø—Ä–æ—Ñ–∏–ª—å)
POST /api/v1/analyze {"profile_url": "@username"}
‚Üí –ü–æ–ø—ã—Ç–∫–∞: 1/1 (–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è)
‚Üí –ö—ç—à: ‚úÖ
‚Üí –ü–∞—Ä—Å–∏–Ω–≥: ‚ùå
‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ (–∏–∑ –∫—ç—à–∞)

# –î–µ–Ω—å 2: –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
POST /api/v1/analyze {"profile_url": "@username"}
‚Üí –ü–æ–ø—ã—Ç–∫–∞: 0/1 ‚Üí 1/1
‚Üí –ö—ç—à: ‚úÖ
‚Üí –ü–∞—Ä—Å–∏–Ω–≥: ‚ùå
‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ (–∏–∑ –∫—ç—à–∞)
```

### –¢–µ—Å—Ç 2: Race condition

```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å 2 –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
curl -X POST /api/v1/analyze &
curl -X POST /api/v1/analyze &

‚Üí –ó–∞–ø—Ä–æ—Å A: –ü—Ä–∏–æ–±—Ä–µ—Ç–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É ‚úÖ
‚Üí –ó–∞–ø—Ä–æ—Å B: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–Ω—è—Ç–∞ ‚ùå
‚Üí –ó–∞–ø—Ä–æ—Å A: –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ø—ã—Ç–∫—É (1/1) ‚úÖ
‚Üí –ó–∞–ø—Ä–æ—Å B: –ñ–¥—ë—Ç 2 —Å–µ–∫—É–Ω–¥—ã...
‚Üí –ó–∞–ø—Ä–æ—Å A: –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ ‚úÖ
‚Üí –ó–∞–ø—Ä–æ—Å A: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∫—ç—à ‚úÖ
‚Üí –ó–∞–ø—Ä–æ—Å A: –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É ‚úÖ
‚Üí –ó–∞–ø—Ä–æ—Å B: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—ç—à ‚úÖ
‚Üí –ó–∞–ø—Ä–æ—Å B: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—ç—à (–±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏) ‚úÖ
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª                                | –°—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ | –°—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ | –ò–∑–º–µ–Ω–µ–Ω–∏–π                |
| ----------------------------------- | --------------- | ------------- | ------------------------ |
| `backend/main.py`                   | 30              | 12            | –õ–æ–≥–∏–∫–∞ –∫—ç—à–∞ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ |
| `backend/services/cache_service.py` | 70              | 0             | –ú–µ—Ç–æ–¥—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏        |
| **–í—Å–µ–≥–æ**                           | **100**         | **12**        | **88**                   |

---

## üéØ –í—ã–≤–æ–¥—ã

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Ç—Ä–∞—Ç—è—Ç –ø–æ–ø—ã—Ç–∫–∏
   - –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ

2. **–ó–∞—â–∏—Ç–∞ –æ—Ç race condition**

   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É –¥–≤–∞–∂–¥—ã
   - –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ Redis

3. **–£–ª—É—á—à–µ–Ω–∞ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å**
   - Graceful degradation –±–µ–∑ Redis
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
   - –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
2. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:** –°–æ–±–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É cache hit rate
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TTL –∫—ç—à–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-10-04  
**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

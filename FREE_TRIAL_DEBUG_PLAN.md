# Free Trial Debug Plan

## ‚úÖ –ß—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. **SERVICE_ROLE_KEY** —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–≤–º–µ—Å—Ç–æ ANON_KEY)
2. **record_free_trial_usage()** —Ç–µ–ø–µ—Ä—å –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
3. **analyze endpoint** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞:

- ‚úÖ Supabase connection —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ SERVICE_KEY –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ (219 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ RPC —Ñ—É–Ω–∫—Ü–∏—è `can_use_free_trial` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `daily_free_analyses` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚ö†Ô∏è **–°–µ–≥–æ–¥–Ω—è 0 –∑–∞–ø–∏—Å–µ–π** - —Ñ—É–Ω–∫—Ü–∏—è –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ!

## üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

### 1. Backend –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã

- –ü—Ä–æ–≤–µ—Ä–∫–∞: `http://localhost:8000/health`
- –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç—É—Å "healthy"

### 2. Frontend –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ backend

- –ü—Ä–æ–≤–µ—Ä–∫–∞: Console –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F12)
- –ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏ "Failed to fetch" –∏–ª–∏ "Network Error"

### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω

- –û—à–∏–±–∫–∞: "User not authenticated, cannot save scan history"
- –ü—Ä–æ–±–ª–µ–º–∞: Frontend Supabase session –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
- –†–µ—à–µ–Ω–∏–µ: –ü–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è

### 4. Backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π –∫–æ–¥ (–¥–æ —Ñ–∏–∫—Å–∞)

- –í–æ–∑–º–æ–∂–Ω–æ Vercel –µ—â–µ –Ω–µ –∑–∞–¥–µ–ø–ª–æ–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ò–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π backend –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª—Å—è

## üìù –®–∞–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å backend

```bash
# –í –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫—Ä–æ–π—Ç–µ:
http://localhost:8000/health

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:
{"status": "healthy", "timestamp": "..."}
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å frontend –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å analysis
3. –ò—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:
   - `üöÄ BACKEND: NEW ANALYSIS REQUEST RECEIVED!`
   - `üéÅ User {username} using FREE TRIAL`
   - `‚úÖ Recorded free trial usage`

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é

**–í DevTools Console –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:**

```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Supabase session
const {
  data: { session },
} = await supabase.auth.getSession();
console.log("Session:", session);

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å user
const {
  data: { user },
} = await supabase.auth.getUser();
console.log("User:", user);
```

–ï—Å–ª–∏ `session` –∏–ª–∏ `user` = null, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è.

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –≤—ã–∑–æ–≤ RPC

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç:**

```bash
cd "C:\Users\ok\Desktop\timo\trendxl 2.0"
python test_free_trial_fix.py <YOUR-USER-UUID>
```

–ü–æ–ª—É—á–∏—Ç—å UUID:

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://supabase.com/dashboard/project/jynidxwtbjrxmsbfpqra/auth/users
2. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'timo'
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ UUID (—Ñ–æ—Ä–º–∞—Ç: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)

### –®–∞–≥ 5: –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Vercel

–ï—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç–µ –Ω–∞ production (Vercel):

1. –û—Ç–∫—Ä–æ–π—Ç–µ Vercel Dashboard
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Environment Variables:
   - `SUPABASE_SERVICE_ROLE_KEY` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
   - –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí service_role key

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:

1. **–í –ª–æ–≥–∞—Ö backend** (–∫–æ–Ω—Å–æ–ª—å –≥–¥–µ –∑–∞–ø—É—â–µ–Ω `python run_server.py`):

```
üéÅ User timo using FREE TRIAL (1/day)
‚úÖ Recorded free trial usage for user {uuid}
üéÅ Free trial used by timo for @amazing.world
```

2. **–í Supabase Dashboard** ‚Üí Table Editor ‚Üí daily_free_analyses:

- –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å —Å:
  - `user_id`: –≤–∞—à UUID
  - `analysis_date`: —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞
  - `analysis_count`: 1
  - `profile_analyzed`: –∏–º—è –ø—Ä–æ—Ñ–∏–ª—è

3. **–í UI**:

- –°—á–µ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å: `0/1 Used Today`
- –ü—Ä–∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ø—ã—Ç–∫–µ: –æ—à–∏–±–∫–∞ 403 "Analysis limit reached"

## üêõ –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:

```bash
python diagnose_free_trial.py
```

–ò –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:

1. –í—ã–≤–æ–¥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
2. –õ–æ–≥–∏ backend (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –°–∫—Ä–∏–Ω—à–æ—Ç Console –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F12)
4. –°–∫—Ä–∏–Ω—à–æ—Ç Network tab –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ analysis

# Система автообновления бесплатных попыток - Руководство

## 📋 Обзор

Реализована улучшенная система учета и отображения бесплатных попыток с автоматическим обновлением данных в реальном времени.

## ✨ Реализованные улучшения

### 1. **Кастомный хук `useAutoRefresh`**

**Файл:** `src/hooks/useAutoRefresh.ts`

Универсальный хук для автоматического обновления данных через заданные интервалы времени.

**Основные функции:**

- `useAutoRefresh(callback, interval, enabled)` - автоматически вызывает callback через заданный интервал
- `calculateTimeUntilReset()` - вычисляет время до сброса попыток (00:00 UTC)
- `formatTimeRemaining(hours, minutes)` - форматирует оставшееся время

**Пример использования:**

```typescript
// Автообновление каждые 60 секунд
useAutoRefresh(loadData, 60000, isEnabled);
```

### 2. **Обновленный `FreeTrialCounter`**

**Файл:** `src/components/FreeTrialCounter.tsx`

**Что улучшено:**

- ✅ Автообновление данных о бесплатных попытках каждые 60 секунд
- ✅ Автообновление времени до сброса попыток каждые 60 секунд
- ✅ Реал-тайм индикация оставшегося времени
- ✅ Использование `useCallback` для оптимизации производительности

**Отображение:**

```
🎨 Если попытка доступна: Фиолетовый фон
🟠 Если попытка использована: Оранжевый фон + таймер сброса
✅ Если активна подписка: Зеленый фон "Premium Active"
```

### 3. **Обновленный `SubscriptionBanner`**

**Файл:** `src/components/SubscriptionBanner.tsx`

**Что улучшено:**

- ✅ Автообновление статуса подписки каждые 60 секунд
- ✅ Автообновление информации о бесплатных попытках каждые 60 секунд
- ✅ Оптимизация с помощью `useCallback` для предотвращения лишних ре-рендеров

**Логика отображения:**

1. Проверяет наличие активной подписки
2. Показывает статус бесплатных попыток (доступна/использована)
3. Предлагает оформить подписку

### 4. **Проверка перед анализом в `useTrendAnalysis`**

**Файл:** `src/hooks/useTrendAnalysis.ts`

**Что добавлено:**

```typescript
// Проверка статуса ПЕРЕД отправкой запроса на бекенд
if (user) {
  const trialInfo = await getFreeTrialInfo();

  if (!trialInfo.is_admin && !trialInfo.has_subscription) {
    if (!trialInfo.can_use_free_trial) {
      // Показываем модальное окно подписки БЕЗ запроса к бекенду
      setShowSubscriptionModal(true);
      return; // Не продолжаем анализ
    }
  }
}
```

**Преимущества:**

- 🚀 **Лучший UX**: пользователь видит модальное окно подписки мгновенно
- ⚡ **Экономия ресурсов**: не отправляем запрос на бекенд, если попытки кончились
- 🔒 **Двойная защита**: проверка и на фронтенде, и на бекенде

### 5. **Улучшенный `SubscriptionModal`**

**Файл:** `src/components/SubscriptionModal.tsx`

**Что улучшено:**

- ✅ Автообновление времени до сброса попыток каждые 60 секунд
- ✅ Динамическое обновление времени пока модальное окно открыто
- ✅ Использование общих функций из `useAutoRefresh`

## 🔄 Как работает система

### Схема работы автообновления:

```
┌─────────────────────────────────────────────────────────────┐
│                      Пользователь                            │
│                           │                                   │
│                           ▼                                   │
│            ┌──────────────────────────────┐                  │
│            │  HomePage с FreeTrialCounter  │                  │
│            │   и SubscriptionBanner        │                  │
│            └──────────────┬───────────────┘                  │
│                           │                                   │
│        ┌──────────────────┼──────────────────┐              │
│        │                  │                  │              │
│        ▼                  ▼                  ▼              │
│  [Автообновление]   [Пользователь]    [После анализа]      │
│  каждые 60 сек      кликает кнопку    refreshTrigger       │
│        │                  │                  │              │
│        └──────────────────┴──────────────────┘              │
│                           │                                   │
│                           ▼                                   │
│              getFreeTrialInfo() API запрос                   │
│                           │                                   │
│                           ▼                                   │
│        ┌──────────────────────────────────────┐             │
│        │  Бекенд: /api/v1/free-trial/info    │             │
│        │  - Проверяет daily_free_analyses     │             │
│        │  - Возвращает статус попыток         │             │
│        └──────────────────┬───────────────────┘             │
│                           │                                   │
│                           ▼                                   │
│        ┌──────────────────────────────────────┐             │
│        │  Supabase: daily_free_analyses       │             │
│        │  - user_id                            │             │
│        │  - analysis_date (CURRENT_DATE)       │             │
│        │  - analysis_count                     │             │
│        │  - last_analysis_timestamp            │             │
│        └───────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────┘
```

### Схема проверки перед анализом:

```
Пользователь вводит ссылку на профиль
            │
            ▼
┌───────────────────────────┐
│ useTrendAnalysis hook     │
│ analyzeTrends()           │
└─────────┬─────────────────┘
          │
          ▼
┌───────────────────────────┐
│ getFreeTrialInfo() API    │◄─── Проверка БЕЗ запроса к бекенду
└─────────┬─────────────────┘     для основного анализа
          │
          ├─────► Есть подписка / админ? ──► Продолжить анализ
          │
          ├─────► Можно использовать free trial? ──► Продолжить анализ
          │
          └─────► Попытки кончились? ──► Показать SubscriptionModal
                                          (НЕ отправлять запрос на бекенд)
```

## 📊 Таблица в Supabase

### `daily_free_analyses`

```sql
CREATE TABLE public.daily_free_analyses (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    analysis_date DATE DEFAULT CURRENT_DATE,
    analysis_count INTEGER DEFAULT 0,
    last_analysis_timestamp TIMESTAMPTZ DEFAULT NOW(),
    profile_analyzed TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, analysis_date)
);
```

**Важно:**

- Записи автоматически создаются/обновляются при каждом анализе
- Уникальное ограничение: один пользователь = одна запись в день
- Сброс счетчика происходит автоматически каждый день (новая дата = новая запись)

## 🔧 Эндпоинты API

### 1. GET `/api/v1/free-trial/info`

Получить информацию о бесплатных попытках текущего пользователя.

**Требования:** Аутентификация

**Ответ:**

```json
{
  "is_admin": false,
  "has_subscription": false,
  "can_use_free_trial": true,
  "today_count": 0,
  "total_free_analyses": 5,
  "daily_limit": 1,
  "last_used": "2025-10-06T12:30:00Z",
  "message": "You have 1 free analysis available today"
}
```

### 2. POST `/api/v1/analyze`

Основной эндпоинт для анализа TikTok профиля.

**Логика проверки:**

1. Проверка аутентификации
2. Если админ → разрешить без ограничений
3. Если есть подписка → разрешить
4. Если есть бесплатная попытка → разрешить + записать использование
5. Иначе → вернуть 403 с `type: "free_trial_exhausted"`

## 🎯 Преимущества новой системы

### Для пользователей:

- ✅ **Видят актуальный статус** попыток в реальном времени
- ✅ **Знают точное время** до восстановления попытки
- ✅ **Мгновенная обратная связь** при попытке анализа без доступных попыток
- ✅ **Нет ожидания** ответа от сервера для проверки статуса

### Для разработчиков:

- 🔧 **Переиспользуемый хук** `useAutoRefresh` для любых компонентов
- 🚀 **Оптимизированная производительность** с `useCallback`
- 🔒 **Двойная защита**: проверка на фронтенде и бекенде
- 📊 **Единообразная логика** отображения времени

### Для бизнеса:

- 💰 **Экономия ресурсов**: меньше запросов к API
- 📈 **Лучшая конверсия**: пользователи видят статус до клика
- 🎯 **Прозрачность**: пользователи всегда знают, сколько попыток осталось

## 🧪 Тестирование

### Сценарии для тестирования:

#### Сценарий 1: Новый пользователь без подписки

1. Зарегистрироваться
2. Увидеть баннер "1 Free Scan Today"
3. Выполнить анализ → успешно
4. Увидеть баннер "0/1 Used Today" с таймером сброса
5. Попытаться выполнить анализ снова → сразу увидеть модальное окно подписки

#### Сценарий 2: Автообновление

1. Войти в систему
2. Открыть страницу
3. Подождать 60 секунд
4. Убедиться, что время до сброса обновилось автоматически
5. Убедиться, что счетчик попыток обновился (если были изменения)

#### Сценарий 3: Пользователь с подпиской

1. Войти в систему с активной подпиской
2. Увидеть зеленый баннер "Premium Active - Unlimited Scans"
3. Выполнить несколько анализов → все успешны
4. Не видеть счетчик бесплатных попыток

#### Сценарий 4: Сброс в полночь UTC

1. Использовать бесплатную попытку
2. Дождаться полуночи UTC
3. Обновить страницу
4. Увидеть, что попытка восстановлена (1/1)

## 🔒 Безопасность

- ✅ Все проверки дублируются на бекенде
- ✅ JWT токены проверяются для каждого запроса
- ✅ RLS (Row Level Security) в Supabase
- ✅ Невозможно обойти лимиты через изменение фронтенда

## 📝 Дальнейшие улучшения (опционально)

1. **WebSocket для реал-тайм обновлений** - получать обновления статуса мгновенно
2. **Push-уведомления** - напоминание о восстановлении попытки
3. **История использования** - график использования попыток за неделю/месяц
4. **A/B тестирование** - разные лимиты для разных пользователей
5. **Гибкие лимиты** - возможность давать бонусные попытки за действия

## 🐛 Известные проблемы

Нет известных проблем на данный момент.

## 📞 Поддержка

При возникновении проблем:

1. Проверьте консоль браузера на наличие ошибок
2. Проверьте логи бекенда
3. Убедитесь, что миграция `supabase_free_trial_migration.sql` выполнена
4. Проверьте переменные окружения (JWT_SECRET, SUPABASE_KEY и т.д.)

---

**Дата реализации:** 6 октября 2025  
**Версия:** 2.0  
**Статус:** ✅ Готово к продакшену
